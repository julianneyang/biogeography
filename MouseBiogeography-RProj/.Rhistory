library(dplyr)
labels_lum <- get_genera_from_plot("Regional-Mouse-Biogeography-Analysis/2021-8-Microbiome-Batch-Correction-Analysis/taxa_barplots/Luminal_level-6.RDS")
labels_muc <- get_genera_from_plot("Regional-Mouse-Biogeography-Analysis/2021-8-Microbiome-Batch-Correction-Analysis/taxa_barplots/Mucosal_level-6.RDS")
#Find out how many taxa need to be assigned colors
labels_all <- union(labels_lum, labels_muc)
#Generate that many colors
assign_cols <- paletteer_d("ggsci::category20_d3", 18)
#Match taxa to colors and then use in scale_fill_manual
names(assign_cols)=labels_all
readr::write_rds(assign_cols,here("Regional-Mouse-Biogeography-Analysis/2021-8-Microbiome-Batch-Correction-Analysis/taxa_barplots/assign_cols.RDS"))
## Remove DSS Samples
metadata<- readr::read_delim("Humanized-Biogeography-Analysis/Humanized Metadata - All-Humanized-Metadata.tsv",delim = "\t")
View(metadata)
## Remove DSS Samples
metadata<- readr::read_delim("Humanized-Biogeography-Analysis/Humanized Metadata.tsv.txt",delim = "\t")
ASV<-readr::read_csv(here("Humanized-Biogeography-Analysis/Humanized ASV and Taxonomy Key - feature-table.csv"))
## Remove DSS Samples
metadata<- readr::read_delim("Humanized-Biogeography-Analysis/Humanized Metadata.tsv.txt",delim = "\t")
## Remove DSS Samples
metadata<- readr::read_delim("Humanized-Biogeography-Analysis/Humanized Metadata - All-Humanized-Metadata.tsv",delim = "\t")
metadata$Sequencing_Run <- factor(metadata$Sequencing_Run)
metadata$DSS_Treatment <- factor(metadata$DSS_Treatment)
samples <- metadata %>% filter(DSS_Treatment =="No", SampleID %in% names(ASV)) %>% pull(SampleID)
final_ASV <- ASV[, samples]
write.table(final_ASV,"Humanized_ASV_for_alpha_diversity.tsv", sep="\t")
View(ASV)
## Filter by Sequencing Run
row.names(final_ASV) <- ASV$OTU.ID
ASV<-readr::read_csv(here("Humanized-Biogeography-Analysis/Humanized ASV and Taxonomy Key - feature-table.csv"))
## Remove DSS Samples
metadata<- readr::read_delim("Humanized-Biogeography-Analysis/Humanized Metadata - All-Humanized-Metadata.tsv",delim = "\t")
metadata$Sequencing_Run <- factor(metadata$Sequencing_Run)
metadata$DSS_Treatment <- factor(metadata$DSS_Treatment)
samples <- metadata %>% filter(DSS_Treatment =="No", SampleID %in% names(ASV)) %>% pull(SampleID)
final_ASV <- ASV[, samples]
write.table(final_ASV,"Humanized_ASV_for_alpha_diversity.tsv", sep="\t")
## Filter by Sequencing Run
row.names(final_ASV) <- ASV$OTU.ID
Nov2014 <- metadata%>% filter(DSS_Treatment=="No"&Sequencing_Run=="2014_Nov", X.SampleID %in% names(ASV)) %>%pull(X.SampleID)
View(final_ASV)
View(final_ASV)
ASV<-readr::read_csv(here("Humanized-Biogeography-Analysis/Humanized ASV and Taxonomy Key - feature-table.csv"))
View(ASV)
ASV<-readr::read_csv(here("Humanized-Biogeography-Analysis/Humanized ASV and Taxonomy Key - feature-table.csv"))
## Remove DSS Samples
metadata<- readr::read_delim("Humanized-Biogeography-Analysis/Humanized Metadata - All-Humanized-Metadata.tsv",delim = "\t")
metadata$Sequencing_Run <- factor(metadata$Sequencing_Run)
metadata$DSS_Treatment <- factor(metadata$DSS_Treatment)
samples <- metadata %>% filter(DSS_Treatment =="No", SampleID %in% names(ASV)) %>% pull(SampleID)
final_ASV <- ASV[, samples]
write.table(final_ASV,"Humanized_ASV_for_alpha_diversity.tsv", sep="\t")
## Filter by Sequencing Run
row.names(final_ASV) <- ASV$
Nov2014 <- metadata%>% filter(DSS_Treatment=="No"&Sequencing_Run=="2014_Nov", X.SampleID %in% names(ASV)) %>%pull(X.SampleID)
## Filter by Sequencing Run
row.names(final_ASV) <- ASV$OTU.ID
View(final_ASV)
Nov2014 <- metadata%>% filter(DSS_Treatment=="No"&Sequencing_Run=="2014_Nov", X.SampleID %in% names(ASV)) %>%pull(X.SampleID)
Nov2014 <- final_ASV[,Nov2014]
Nov2014 <- metadata%>% filter(DSS_Treatment=="No"&Sequencing_Run=="2014_Nov", X.SampleID %in% names(ASV)) %>%pull(SampleID)
Nov2014 <- metadata%>% filter(DSS_Treatment=="No"&Sequencing_Run=="2014_Nov", SampleID %in% names(ASV)) %>%pull(SampleID)
Nov2014 <- final_ASV[,Nov2014]
Sep2014 <- metadata%>% filter(DSS_Treatment=="No"&Sequencing_Run=="2014_Sept", SampleID %in% names(ASV)) %>%pull(SampleID)
Sep2014 <- final_ASV[,Sep2014]
Sep2015 <- metadata%>% filter(DSS_Treatment=="No"&Sequencing_Run=="2015_Sept", SampleID %in% names(ASV)) %>%pull(SampleID)
Sep2015 <- final_ASV[,Sep2015]
## Apply feature prevalence filter of 15% to each Sequencing Run dataset
#Nov2014
t_df_input_data<-as.data.frame(t(Nov2014))
ctr= 0
prevalence <- vector(mode="numeric")
for(i in 1:ncol(t_df_input_data)){
v<-t_df_input_data %>% pull(i)
for(j in 1:length(v)){
if (t_df_input_data[j,i]>0){
ctr=1+ctr
}
else {
ctr=ctr
}
}
prevalence<-append(prevalence,ctr)
ctr=0
}
Nov2014$prevalence<-prevalence #features present in at least 15 samples our of 100
Nov2014<- Nov2014 %>% filter(prevalence>=15) #[Result: 509 features, 100 samples]
#Sep2014
t_df_input_data<-as.data.frame(t(Sep2014))
ctr= 0
prevalence <- vector(mode="numeric")
for(i in 1:ncol(t_df_input_data)){
v<-t_df_input_data %>% pull(i)
for(j in 1:length(v)){
if (t_df_input_data[j,i]>0){
ctr=1+ctr
}
else {
ctr=ctr
}
}
prevalence<-append(prevalence,ctr)
ctr=0
}
70*0.15
Sep2014$prevalence<-prevalence#features present in at least 11 samples our of 70
Sep2014<- Sep2014 %>% filter(prevalence>=11) #[Result: 488 features, 70 samples]
#Sep2015
t_df_input_data<-as.data.frame(t(Sep2015))
ctr= 0
prevalence <- vector(mode="numeric")
for(i in 1:ncol(t_df_input_data)){
v<-t_df_input_data %>% pull(i)
for(j in 1:length(v)){
if (t_df_input_data[j,i]>0){
ctr=1+ctr
}
else {
ctr=ctr
}
}
prevalence<-append(prevalence,ctr)
ctr=0
}
Sep2015$prevalence<-prevalence#features present in at least 6 samples out of 43
Sep2015<- Sep2015 %>% filter(prevalence>=6) #[Result: 363 features, 43 samples]
target1 <- intersect(row.names(Nov2014),row.names(Sep2014)) #[452 features]
target <- intersect(target1, row.names(Sep2015)) #[263 features]
Nov2014<-Nov2014[row.names(Nov2014) %in% target,]
Sep2014<-Sep2014[row.names(Sep2014) %in% target,]
Sep2015<-Sep2015[row.names(Sep2015) %in% target,]
row.names(Nov2014) ==row.names(Sep2014)
row.names(Nov2014) ==row.names(Sep2015)
final_humanized_ASV <- cbind(Nov2014,Sep2014,Sep2015)
final_humanized_ASV <-select(final_humanized_ASV, -prevalence) #[263 features, 213 samples]
## Perform CombatSeq2 by Type and Site
newmeta <- metadata %>% filter(DSS_Treatment =="No")
batch<- as.character(newmeta$Sequencing_Run)
modcombat=model.matrix(~ Microbiota + Type + Sex + Site,data=newmeta)
input=as.matrix(final_humanized_ASV)
combat_adjusted_counts=ComBat_seq(input,batch=batch,group=NULL,covar_mod=modcombat)
###Purpose: Use only features from first dataset present in this dataset, then remove 2017_April and 2015_September Sequencing Run
###then perform CombatSeq2
library(dplyr)
library(sva)
modcombat=model.matrix(~ Microbiota + Type + Sex + Site,data=newmeta)
input=as.matrix(final_humanized_ASV)
combat_adjusted_counts=ComBat_seq(input,batch=batch,group=NULL,covar_mod=modcombat)
library(ggplot2)
library(vegan)
library(dplyr)
library(rlang)
library(cowplot)
library(viridis)
data<-read.table(file ="CS-Facility-Analysis/RPCA/rpca_dm/dm_rpca_SI_CS-Facility-ComBat-Adjusted-ASV.qza.txt/distance-matrix.tsv")
metadata <- read.csv("CS-Facility-Analysis/CS_Facility_Metadata.csv", header=TRUE, row.names=1)
setwd("/home/julianne/Documents/microbiome.biogeography/")
devtools::document()
library("Microbiome.Biogeography")
setwd("/home/julianne/Documents/biogeography/")
library(ggplot2)
library(vegan)
library(dplyr)
library(rlang)
library(cowplot)
library(viridis)
data<-read.table(file ="CS-Facility-Analysis/RPCA/rpca_dm/dm_rpca_SI_CS-Facility-ComBat-Adjusted-ASV.qza.txt/distance-matrix.tsv")
metadata <- read.csv("CS-Facility-Analysis/CS_Facility_Metadata.csv", header=TRUE, row.names=1)
# Ensure metadata matches sample order in distance matrix
data.dist <- as.dist(as(data, "matrix"))
target <- row.names(data)
metadata <- metadata[match(target, row.names(metadata)),]
target == row.names(metadata)
permute_within <- c("Site")
subject_data <- c("Sequencing_Run", "Sex", "MouseID")
# Wrangle metadata into appropriate formats
general_metadata<- dplyr::select(metadata, c(permute_within))
metadata_subj <- dplyr::select(metadata, c(subject_data))
metadata_subj <-as.data.frame(metadata_subj[!duplicated(metadata$MouseID),]) #one of these columns is your SubjectID
row.names(metadata_subj) <- metadata_subj$MouseID
View(metadata)
View(metadata_subj)
subjectvector <- c(metadata$MouseID)
order_vector <- head(subject_data,-1)
order_vector <- c(order_vector, permute_within)
data.adonis <- PERMANOVA_repeat_measures(D = data.dist, permutations=10000,
permute_within= general_metadata,
blocks= subjectvector,
block_data=metadata_subj,
metadata_order=order_vector)
data.adonis
View(metadata_subj)
data.adonis <- PERMANOVA_repeat_measures(D = data.dist, permutations=10000,
permute_within= general_metadata,
blocks= subjectvector,
block_data=metadata_subj,
metadata_order=order_vector)
data.adonis
View(metadata)
# Wrangle metadata into appropriate formats
general_metadata<-as.data.frame(metadata[,c('Sequencing_Run','Sex','Site','Genotype')])  # select columns within which to permute
View(general_metadata)
View(general_metadata)
metadata_subj <- metadata[,c('MouseID')] # select column with column ID containing blocking factor
View(metadata)
metadata_subj <- metadata[!duplicated(metadata$MouseID),grepl("MouseID",colnames(metadata)), drop=F]
View(metadata_subj)
rownames(metadata_subj) <- metadata_subj$MouseID
metadata_subj <- metadata[!duplicated(metadata$MouseID),grepl("MouseID",colnames(metadata)), drop=F]
subjectvector <- c(metadata$MouseID)
data.adonis <- PERMANOVA_repeat_measures(D = data.dist, permutations=10000,
permute_within= general_metadata,
blocks= subjectvector,
block_data=metadata_subj,
metadata_order=order_vector)
run_repeated_PERMANOVA_donors <- function(path_to_distance_matrix_tsv,path_to_metadata_csv,permute_columns_vector, subject_metadata_vector){
#data<-read.table(file ="CS-Facility-Analysis/RPCA/rpca_dm/dm_rpca_SI_CS-Facility-ComBat-Adjusted-ASV.qza.txt/distance-matrix.tsv")
#metadata <- read.csv("CS-Facility-Analysis/CS_Facility_Metadata.csv", header=TRUE, row.names=1)
#data<- read.table( "Donors-Analysis/site_rpca/dm_rpca_SI_Mucosal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv")
#metadata <- read.delim("Donors-Analysis/starting_files/Donors_Metadata.tsv",header=T,row.names=1)
# Read in files ---
data<-read.table(path_to_distance_matrix_tsv)
row.names(data) <- gsub("-",".",row.names(data))
metadata <- read.delim(here(path_to_metadata_csv), header=T, row.names=1)
row.names(metadata) <- gsub("-",".",row.names(metadata))
# Ensure metadata matches sample order in distance matrix
data.dist <- as.dist(as(data, "matrix"))
target <- row.names(data)
metadata <- metadata[match(target, row.names(metadata)),]
target == row.names(metadata)
# Read in relevant metadata, where permute_within (Timepoint, SampleType) and subject data (Age,Sex)
permute_within <- c(permute_columns_vector)
subject_data <- c(subject_metadata_vector)
permute_within <- c("Site")
subject_data <- c("Sequencing_Run", "Sex", "MouseID")
# Wrangle metadata into appropriate formats
general_metadata<- dplyr::select(metadata, c(permute_within))
metadata_subj <- dplyr::select(metadata, c(subject_data))
metadata_subj <-as.data.frame(metadata_subj[!duplicated(metadata$MouseID),]) #one of these columns is your SubjectID
row.names(metadata_subj) <- metadata_subj$MouseID
#metadata_subj <- dplyr::select(metadata_subj, -MouseID)
subjectvector <- c(metadata$MouseID)
#order_vector <- head(subject_data,-1)
order_vector <- c(order_vector, permute_within)
# Run repeat-measrues aware PERMANOVA (Lloyd-Price et al., 2019)
data.adonis <- PERMANOVA_repeat_measures(D = data.dist, permutations=10000,
permute_within= general_metadata,
blocks= subjectvector,
block_data=metadata_subj,
metadata_order=order_vector)
data.adonis
}
permute_within <- c("Site")
subject_data <- c("Sequencing_Run", "Sex", "MouseID")
# Mucosal SI
run_repeated_PERMANOVA_donors(path_to_distance_matrix_tsv = "Donors-Analysis/site_rpca/dm_rpca_SI_Mucosal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv",
path_to_metadata_csv = "Donors-Analysis/starting_files/Donors_Metadata.tsv",
permute_columns_vector = permute_within,
subject_metadata_vector=subject_data)
library(here)
here::i_am("MouseBiogeography-RProj/Donors-BetaDiversity.R")
# Mucosal SI
run_repeated_PERMANOVA_donors(path_to_distance_matrix_tsv = "Donors-Analysis/site_rpca/dm_rpca_SI_Mucosal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv",
path_to_metadata_csv = "Donors-Analysis/starting_files/Donors_Metadata.tsv",
permute_columns_vector = permute_within,
subject_metadata_vector=subject_data)
# Mucosal Colon
run_repeated_PERMANOVA(path_to_distance_matrix_tsv = "Donors-Analysis/site_rpca/dm_rpca_Colon_Mucosal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv",
path_to_metadata_csv = "Donors-Analysis/starting_files/Donors_Metadata.tsv",
permute_columns_vector = permute_within,
subject_metadata_vector=subject_data)
# Mucosal Colon
run_repeated_PERMANOVA(path_to_distance_matrix_tsv = "Donors-Analysis/site_rpca/dm_rpca_Colon_Mucosal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv",
path_to_metadata_csv = "Donors-Analysis/starting_files/Donors_Metadata.tsv",
permute_columns_vector = permute_within,
subject_metadata_vector=subject_data)
permute_within <- c("Site")
subject_data <- c("Sequencing_Run", "Sex", "MouseID")
# Mucosal Colon
run_repeated_PERMANOVA(path_to_distance_matrix_tsv = "Donors-Analysis/site_rpca/dm_rpca_Colon_Mucosal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv",
path_to_metadata_csv = "Donors-Analysis/starting_files/Donors_Metadata.tsv",
permute_columns_vector = permute_within,
subject_metadata_vector=subject_data)
# Luminal SI
run_repeated_PERMANOVA(path_to_distance_matrix_tsv = "Donors-Analysis/site_rpca/dm_rpca_SI_Luminal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv",
path_to_metadata_csv = "Donors-Analysis/starting_files/Donors_Metadata.tsv",
permute_columns_vector = permute_within,
subject_metadata_vector=subject_data)
# Luminal Colon
run_repeated_PERMANOVA(path_to_distance_matrix_tsv = "Donors-Analysis/site_rpca/dm_rpca_Colon_Luminal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv",
path_to_metadata_csv = "Donors-Analysis/starting_files/Donors_Metadata.tsv",
permute_columns_vector = permute_within,
subject_metadata_vector=subject_data)
# Mucosal SI
run_repeated_PERMANOVA_donors(path_to_distance_matrix_tsv = "Donors-Analysis/site_rpca/dm_rpca_SI_Mucosal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv",
path_to_metadata_csv = "Donors-Analysis/starting_files/Donors_Metadata.tsv",
permute_columns_vector = permute_within,
subject_metadata_vector=subject_data)
# Mucosal Colon
run_repeated_PERMANOVA_donors(path_to_distance_matrix_tsv = "Donors-Analysis/site_rpca/dm_rpca_Colon_Mucosal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv",
path_to_metadata_csv = "Donors-Analysis/starting_files/Donors_Metadata.tsv",
permute_columns_vector = permute_within,
subject_metadata_vector=subject_data)
# Luminal Colon
run_repeated_PERMANOVA_donors(path_to_distance_matrix_tsv = "Donors-Analysis/site_rpca/dm_rpca_Colon_Luminal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv",
path_to_metadata_csv = "Donors-Analysis/starting_files/Donors_Metadata.tsv",
permute_columns_vector = permute_within,
subject_metadata_vector=subject_data)
permute_within <- c("Site_General")
subject_data <- c("Sequencing_Run", "Sex", "MouseID")
permute_within <- c("Site")
subject_data <- c("Sequencing_Run", "Sex", "MouseID")
# Luminal SI
run_repeated_PERMANOVA_donors(path_to_distance_matrix_tsv = "Donors-Analysis/site_rpca/dm_rpca_SI_Luminal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv",
path_to_metadata_csv = "Donors-Analysis/starting_files/Donors_Metadata.tsv",
permute_columns_vector = permute_within,
subject_metadata_vector=subject_data)
permute_within <- c("Site_General")
subject_data <- c("Sequencing_Run", "Sex", "MouseID")
# Luminal
run_repeated_PERMANOVA_donors(path_to_distance_matrix_tsv = "Donors-Analysis/site_rpca/dm_rpca_Luminal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv",
path_to_metadata_csv = "Donors-Analysis/starting_files/Donors_Metadata.tsv",
permute_columns_vector = permute_within,
subject_metadata_vector=subject_data)
permute_within <- c("Site_General")
subject_data <- c("Sequencing_Run", "Sex", "MouseID")
run_repeated_PERMANOVA_donors <- function(path_to_distance_matrix_tsv,path_to_metadata_csv,permute_columns_vector, subject_metadata_vector){
#data<-read.table(file ="CS-Facility-Analysis/RPCA/rpca_dm/dm_rpca_SI_CS-Facility-ComBat-Adjusted-ASV.qza.txt/distance-matrix.tsv")
#metadata <- read.csv("CS-Facility-Analysis/CS_Facility_Metadata.csv", header=TRUE, row.names=1)
#data<- read.table( "Donors-Analysis/site_rpca/dm_rpca_SI_Mucosal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv")
#metadata <- read.delim("Donors-Analysis/starting_files/Donors_Metadata.tsv",header=T,row.names=1)
# Read in files ---
data<-read.table(path_to_distance_matrix_tsv)
row.names(data) <- gsub("-",".",row.names(data))
metadata <- read.delim(here(path_to_metadata_csv), header=T, row.names=1)
row.names(metadata) <- gsub("-",".",row.names(metadata))
# Ensure metadata matches sample order in distance matrix
data.dist <- as.dist(as(data, "matrix"))
target <- row.names(data)
metadata <- metadata[match(target, row.names(metadata)),]
target == row.names(metadata)
# Read in relevant metadata, where permute_within (Timepoint, SampleType) and subject data (Age,Sex)
permute_within <- c(permute_columns_vector)
subject_data <- c(subject_metadata_vector)
#permute_within <- c("Site")
#subject_data <- c("Sequencing_Run", "Sex", "MouseID")
# Wrangle metadata into appropriate formats
general_metadata<- dplyr::select(metadata, c(permute_within))
metadata_subj <- dplyr::select(metadata, c(subject_data))
metadata_subj <-as.data.frame(metadata_subj[!duplicated(metadata$MouseID),]) #one of these columns is your SubjectID
row.names(metadata_subj) <- metadata_subj$MouseID
#metadata_subj <- dplyr::select(metadata_subj, -MouseID)
subjectvector <- c(metadata$MouseID)
order_vector <- head(subject_data,-1)
order_vector <- c(order_vector, permute_within)
# Run repeat-measrues aware PERMANOVA (Lloyd-Price et al., 2019)
data.adonis <- PERMANOVA_repeat_measures(D = data.dist, permutations=10000,
permute_within= general_metadata,
blocks= subjectvector,
block_data=metadata_subj,
metadata_order=order_vector)
data.adonis
}
permute_within <- c("Site_General")
subject_data <- c("Sequencing_Run", "Sex", "MouseID")
# Luminal
run_repeated_PERMANOVA_donors(path_to_distance_matrix_tsv = "Donors-Analysis/site_rpca/dm_rpca_Luminal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv",
path_to_metadata_csv = "Donors-Analysis/starting_files/Donors_Metadata.tsv",
permute_columns_vector = permute_within,
subject_metadata_vector=subject_data)
run_repeated_PERMANOVA_donors <- function(path_to_distance_matrix_tsv,path_to_metadata_csv,permute_columns_vector, subject_metadata_vector){
#data<-read.table(file ="CS-Facility-Analysis/RPCA/rpca_dm/dm_rpca_SI_CS-Facility-ComBat-Adjusted-ASV.qza.txt/distance-matrix.tsv")
#metadata <- read.csv("CS-Facility-Analysis/CS_Facility_Metadata.csv", header=TRUE, row.names=1)
#data<- read.table( "Donors-Analysis/site_rpca/dm_rpca_SI_Mucosal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv")
#metadata <- read.delim("Donors-Analysis/starting_files/Donors_Metadata.tsv",header=T,row.names=1)
# Read in files ---
data<-read.table(path_to_distance_matrix_tsv)
row.names(data) <- gsub("-",".",row.names(data))
metadata <- read.delim(here(path_to_metadata_csv), header=T, row.names=1)
row.names(metadata) <- gsub("-",".",row.names(metadata))
# Ensure metadata matches sample order in distance matrix
data.dist <- as.dist(as(data, "matrix"))
target <- row.names(data)
metadata <- metadata[match(target, row.names(metadata)),]
target == row.names(metadata)
# Read in relevant metadata, where permute_within (Timepoint, SampleType) and subject data (Age,Sex)
permute_within <- c(permute_columns_vector)
subject_data <- c(subject_metadata_vector)
#permute_within <- c("Site")
#subject_data <- c("Sequencing_Run", "Sex", "MouseID")
# Wrangle metadata into appropriate formats
general_metadata<- dplyr::select(metadata, c(permute_within))
metadata_subj <- dplyr::select(metadata, c(subject_data))
metadata_subj <-as.data.frame(metadata_subj[!duplicated(metadata$MouseID),]) #one of these columns is your SubjectID
row.names(metadata_subj) <- metadata_subj$MouseID
metadata_subj <- dplyr::select(metadata_subj, -MouseID)
subjectvector <- c(metadata$MouseID)
order_vector <- head(subject_data,-1)
order_vector <- c(order_vector, permute_within)
# Run repeat-measrues aware PERMANOVA (Lloyd-Price et al., 2019)
data.adonis <- PERMANOVA_repeat_measures(D = data.dist, permutations=10000,
permute_within= general_metadata,
blocks= subjectvector,
block_data=metadata_subj,
metadata_order=order_vector)
data.adonis
}
permute_within <- c("Site_General")
subject_data <- c("Sequencing_Run", "Sex", "MouseID")
# Luminal
run_repeated_PERMANOVA_donors(path_to_distance_matrix_tsv = "Donors-Analysis/site_rpca/dm_rpca_Luminal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv",
path_to_metadata_csv = "Donors-Analysis/starting_files/Donors_Metadata.tsv",
permute_columns_vector = permute_within,
subject_metadata_vector=subject_data)
# Luminal Colon
result <- run_repeated_PERMANOVA_donors(path_to_distance_matrix_tsv = "Donors-Analysis/site_rpca/dm_rpca_Colon_Luminal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv",
path_to_metadata_csv = "Donors-Analysis/starting_files/Donors_Metadata.tsv",
permute_columns_vector = permute_within,
subject_metadata_vector=subject_data)
permute_within <- c("Site")
subject_data <- c("Sequencing_Run", "Sex", "MouseID")
# Luminal Colon
result <- run_repeated_PERMANOVA_donors(path_to_distance_matrix_tsv = "Donors-Analysis/site_rpca/dm_rpca_Colon_Luminal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv",
path_to_metadata_csv = "Donors-Analysis/starting_files/Donors_Metadata.tsv",
permute_columns_vector = permute_within,
subject_metadata_vector=subject_data)
result$
permute_within <- c("Site_General")
result$`Pr(>F)`
result$aov.tab
result$aov.tab
result
# Luminal Colon
data<- read.table( "Donors-Analysis/site_rpca/dm_rpca_Colon_Luminal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv")
metadata <- read.delim("Donors-Analysis/starting_files/Donors_Metadata.tsv",header=T,row.names=1)
row.names(metadata) <- gsub("-",".",row.names(metadata))
data.dist <- as.dist(as(data, "matrix"))
target <- row.names(data)
metadata <- metadata[match(target, row.names(metadata)),]
target == row.names(metadata)
# Luminal Colon
data<- read.table( "Donors-Analysis/site_rpca/dm_rpca_Colon_Luminal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv")
metadata <- read.delim("Donors-Analysis/starting_files/Donors_Metadata.tsv",header=T,row.names=1)
row.names(data) <- gsub("-",".",row.names(data))
row.names(metadata) <- gsub("-",".",row.names(metadata))
data.dist <- as.dist(as(data, "matrix"))
target <- row.names(data)
metadata <- metadata[match(target, row.names(metadata)),]
target == row.names(metadata)
data.adonis=adonis2(data.dist ~ Sequencing_Run + Sex + Site, data=metadata, permutations=10000)
data.adonis$aov.tab
data.adonis
# Luminal Colon
data<- read.table( "Donors-Analysis/site_rpca/dm_rpca_Colon_Luminal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv")
metadata <- read.delim("Donors-Analysis/starting_files/Donors_Metadata.tsv",header=T,row.names=1)
row.names(data) <- gsub("-",".",row.names(data))
row.names(metadata) <- gsub("-",".",row.names(metadata))
data.dist <- as.dist(as(data, "matrix"))
target <- row.names(data)
metadata <- metadata[match(target, row.names(metadata)),]
target == row.names(metadata)
data.adonis=adonis2(data.dist ~ Sequencing_Run + Sex + Site, data=metadata, permutations=10000)
data.adonis
# Luminal
data<- read.table( "Donors-Analysis/site_rpca/dm_rpca_Luminal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv")
metadata <- read.delim("Donors-Analysis/starting_files/Donors_Metadata.tsv",header=T,row.names=1)
row.names(data) <- gsub("-",".",row.names(data))
row.names(metadata) <- gsub("-",".",row.names(metadata))
data.dist <- as.dist(as(data, "matrix"))
target <- row.names(data)
metadata <- metadata[match(target, row.names(metadata)),]
target == row.names(metadata)
data.adonis=adonis2(data.dist ~ Sequencing_Run + Sex + Site_General, data=metadata, permutations=10000)
data.adonis
data.adonis=adonis2(data.dist ~ Sequencing_Run + Sex + Donor_ID + Site_General, data=metadata, permutations=10000)
data.adonis
# Luminal Colon
data<- read.table( "Donors-Analysis/site_rpca/dm_rpca_Colon_Luminal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv")
metadata <- read.delim("Donors-Analysis/starting_files/Donors_Metadata.tsv",header=T,row.names=1)
row.names(data) <- gsub("-",".",row.names(data))
row.names(metadata) <- gsub("-",".",row.names(metadata))
data.dist <- as.dist(as(data, "matrix"))
target <- row.names(data)
metadata <- metadata[match(target, row.names(metadata)),]
target == row.names(metadata)
data.adonis=adonis2(data.dist ~ Sequencing_Run + Sex + Donor_ID+Site, data=metadata, permutations=10000)
data.adonis
# Mucosal
data<- read.table( "Donors-Analysis/site_rpca/dm_rpca_Mucosal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv")
metadata <- read.delim("Donors-Analysis/starting_files/Donors_Metadata.tsv",header=T,row.names=1)
row.names(data) <- gsub("-",".",row.names(data))
row.names(metadata) <- gsub("-",".",row.names(metadata))
data.dist <- as.dist(as(data, "matrix"))
target <- row.names(data)
metadata <- metadata[match(target, row.names(metadata)),]
target == row.names(metadata)
data.adonis=adonis2(data.dist ~ Sequencing_Run + Sex + Site_General, data=metadata, permutations=10000)
data.adonis
data.adonis=adonis2(data.dist ~ Sequencing_Run + Sex + Donor_ID + Site_General, data=metadata, permutations=10000)
data.adonis
# Mucosal
data<- read.table( "Donors-Analysis/site_rpca/dm_rpca_Mucosal_Donors-Mice-1xPrev0.15-ComBat-ASV.qza.txt/distance-matrix.tsv")
metadata <- read.delim("Donors-Analysis/starting_files/Donors_Metadata.tsv",header=T,row.names=1)
row.names(data) <- gsub("-",".",row.names(data))
row.names(metadata) <- gsub("-",".",row.names(metadata))
data.dist <- as.dist(as(data, "matrix"))
target <- row.names(data)
metadata <- metadata[match(target, row.names(metadata)),]
target == row.names(metadata)
metadata$Donor_ID <- factor(metadata$Donor_ID)
metadata$Donor_ID
data.adonis=adonis2(data.dist ~ Sequencing_Run + Sex + Donor_ID + Site_General, data=metadata, permutations=10000)
data.adonis
