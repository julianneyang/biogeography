#########3.21.2021 Used for immune deficiency biogeography project###########

####Same process done for 2014_Sept, 2014_Nov_Lane1, and 2014_Nov_Lane2 multiplexed files 

cd dir (for the directory with the fastq files)

cat *L001_R1*.fastq.gz > L001_R1.fastq.gz    # modify based on lane designation in file name

cat *L001_R2*.fastq.gz > L001_R2.fastq.gz    # barcode reads 

cat *L001_R3*.fastq.gz > L001_R3.fastq.gz   

gunzip -d L001_R1.fastq.gz

gunzip -d L001_R2.fastq.gz

gunzip -d L001_R3.fastq.gz

sed 's/2:N:0/1:N:0/g' L001_R2.fastq > L001_R2_FixedHeaders.fastq

# Put files on desktop (due to problems with "text file busy error")

cd

cd Desktop

join_paired_ends.py -f L001_R1.fastq -r L001_R3.fastq -b L001_R2_FixedHeaders.fastq -o L001_fastq-join_joined 

cd L001_fastq-join_joined

count_seqs.py -i fastqjoin.join.fastq

# place mapping file in joined folder    **** VERY IMPORTANT: NO UNDERSCORES IN SAMPLE NAME; OK to use dashes ****  # also make sure that there are no duplicate sample IDs

split_libraries_fastq.py -i fastqjoin.join.fastq -o output_dir/ -b fastqjoin.join_barcodes.fastq -m June_2016_mapping_fixed2.txt --rev_comp_mapping_barcodes -q 19 --store_demultiplexed_fastq

split_sequence_file_on_sample_ids.py -i seqs.fastq --file_type fastq -o out_fastq/

####Then, compile all the demultiplexed files from 2015 and more recent, for the ImmDef Project. Make manifest file for all files and import. 

time qiime tools import   --type 'SampleData[PairedEndSequencesWithQuality]' --input-format PairedEndFastqManifestPhred33 --input-path '/media/sf_Shared_Folder/Julianne_SLCCre/2015andup-ImmuneDeficiency-Demux/2015andup-ImmDef-Manifest.csv' --output-path 2015andup-ImmDef-pairedend-demux.qza

time qiime demux summarize --i-data '/media/sf_Shared_Folder/Julianne_SLCCre/2015andup-ImmuneDeficiency-Demux/2015andup-ImmDef-pairedend-demux.qza' --o-visualization '/media/sf_Shared_Folder/Julianne_SLCCre/2015andup-ImmuneDeficiency-Demux/2015andup-ImmDef-pairedend-demux-vis.qza' 

time qiime vsearch join-pairs --i-demultiplexed-seqs '/media/sf_Shared_Folder/Julianne_SLCCre/2015andup-ImmuneDeficiency-Demux/2015andup-ImmDef-pairedend-demux.qza' --o-joined-sequences 2015andup-ImmDef-joined-demux.qza --p-truncqual 19 --p-minlen 135 --p-minmergelen 240 --p-maxmergelen 270 --p-threads 8

time qiime tools export --input-path '/media/sf_Shared_Folder/Julianne_SLCCre/2015andup-ImmuneDeficiency-Demux/2015andup-ImmDef-joined-demux.qza' --output-path '/media/sf_Shared_Folder/Julianne_SLCCre/2015andup-ImmuneDeficiency-Demux/2015andup-ImmDef-joined-exported'

####Then, move all the demuliplexed, joined FastQ files belonging to Immune-Deficiency project to one folder, and convert all "_" to "-"

time qiime tools import   --type 'SampleData[SequencesWithQuality]' --input-path '/media/sf_Shared_Folder/Julianne_SLCCre/all-ImmDef-FastQ-joined/all-immdef-Manifest.csv' --input-format SingleEndFastqManifestPhred33 --output-path all-ImmDef-FastQ-joined.qza

time qiime demux summarize --i-data '/media/sf_Shared_Folder/Julianne_SLCCre/all-ImmDef-FastQ-joined/all-ImmDef-FastQ-joined.qza' --o-visualization '/media/sf_Shared_Folder/Julianne_SLCCre/all-ImmDef-FastQ-joined/all-ImmDef-FastQ-joined-vis.qzv'

qiime quality-filter q-score --i-demux '/media/sf_Shared_Folder/Julianne_SLCCre/all-ImmDef-FastQ-joined/all-ImmDef-FastQ-joined.qza' --o-filtered-sequences all-ImmDef-joined-filtered.qza --o-filter-stats all-ImmDef-joined-filter-stats.qza
time qiime deblur denoise-16S --i-demultiplexed-seqs '/media/sf_Shared_Folder/Julianne_SLCCre/all-ImmDef-FastQ-joined/all-ImmDef-joined-filtered.qza' --p-trim-length 250 --p-sample-stats  --o-representative-sequences all-Imm-Def-rep-seqs.qza --o-table all-ImmDef-table.qza --p-jobs-to-start 23 --o-stats deblur-stats.qza --verbose

time qiime deblur denoise-16S --i-demultiplexed-seqs '/media/sf_Shared_Folder/Julianne_SLCCre/all-ImmDef-FastQ-joined/all-ImmDef-joined-filtered.qza' --p-trim-length 250 --p-sample-stats  --o-representative-sequences all-Imm-Def-rep-seqs.qza --o-table all-ImmDef-table.qza --p-jobs-to-start 23 --o-stats deblur-stats.qza --verbose

####Compile all demuxed files from 2015 and up for the Humanized Project.

(qiime2-2020.8) qiime2@qiime2core2020-8:/media/sf_Shared_Folder/Julianne_SLCCre/All Humanized Demux FastQ Files/2015andup-Humanized-Demux$ time qiime tools import   --type 'SampleData[PairedEndSequencesWithQuality]' --input-format PairedEndFastqManifestPhred33 --input-path '/media/sf_Shared_Folder/Julianne_SLCCre/All Humanized Demux FastQ Files/2015andup-Humanized-D 

time qiime vsearch join-pairs --i-demultiplexed-seqs '/media/sf_Shared_Folder/Julianne_SLCCre/All Humanized Demux FastQ Files/2015andup-Humanized-Demux/2015andup-Humanized-demux-paired.qza' --o-joined-sequences '/media/sf_Shared_Folder/Julianne_SLCCre/All Humanized Demux FastQ Files/2015andup-Humanized-Demux/2015andup-Humanized-demux-joined.qza' --p-truncqual 19 --p-minlen 135 --p-minmergelen 240 --p-maxmergelen 270 --p-threads 8 

 time qiime tools export --input-path '/media/sf_Shared_Folder/Julianne_SLCCre/All Humanized Demux FastQ Files/2015andup-Humanized-Demux/2015andup-Humanized-demux-joined.qza' --output-path '/media/sf_Shared_Folder/Julianne_SLCCre/All Humanized Demux FastQ Files/2015andup-Humanized-Demux/2015andup-Humanized-demux-joined-exported

time qiime tools import   --type 'SampleData[SequencesWithQuality]' --input-format SingleEndFastqManifestPhred33 --input-path'/media/sf_Shared_Folder/Julianne_SLCCre/All-Humanized-BIOGEO-FastQ-Joined/all-

qiime quality-filter q-score --i-demux '/media/sf_Shared_Folder/Julianne_SLCCre/All-Humanized-BIOGEO-FastQ-Joined/all-humanized-joined.qza' --o-filtered-sequences '/media/sf_Shared_Folder/Julianne_SLCCre/All-Humanized-BIOGEO-FastQ-Joined/all-humanized-joined-filtered.qza' --o-filter-stats '/media/sf_Shared_Folder/Julianne_SLCCre/All-Humanized-BIOGEO-FastQ-Joined/all-humanized-joined-filtered-stats.qza' 

 time qiime deblur denoise-16S --i-demultiplexed-seqs '/media/sf_Shared_Folder/Julianne_SLCCre/All-Humanized-BIOGEO-FastQ-Joined/all-humanized-joined-filtered.qza' --p-trim-length 250 --p-sample-stats  --o-representative-sequences all-humanized-rep-seqs.qza --o-table all-humanized-table.qza --p-jobs-to-start 23 --o-stats humanized-deblur-stats.qza
